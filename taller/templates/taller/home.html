<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio - ServiMax</title>
    <link rel="stylesheet" href="{% static 'taller/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================= */
        /* ESTILO MINIMALISTA Y LIMPIO               */
        /* ========================================= */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Fondo gris s√∫per clarito */
            color: #1e293b; /* Texto gris muy oscuro (m√°s suave que negro) */
            margin: 0;
            padding: 0;
        }

        .container { max-width: 1500px !important; margin: 0 auto; padding: 20px; }

        /* Paneles limpios con sombras suaves y bordes muy redondeados */
        .section-panel {
            background: #ffffff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03), 0 2px 4px -1px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.05em;
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Botones elegantes */
        .nav-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .nav-btn {
            display: inline-flex; align-items: center; justify-content: center;
            color: white; padding: 10px 18px; text-decoration: none;
            border-radius: 10px; font-weight: 600; font-size: 0.9em;
            transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: none;
        }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.1); filter: brightness(1.05); }

        /* Tarjetas de Resumen Financiero */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
            transition: all 0.3s ease; border-top: 4px solid #cbd5e1;
            position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 25px -5px rgba(0,0,0,0.08); }
        .card h3 { margin-top: 0; color: #64748b; font-size: 1.05em; font-weight: 600; }
        .card .amount { font-size: 2.2em; font-weight: 700; margin: 10px 0; letter-spacing: -0.02em; }
        
        /* Colores Modernos para el texto y tarjetas */
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
        .text-primary { color: #3b82f6; }
        .text-warning { color: #f59e0b; }

        /* Layout a dos columnas */
        .layout-wrapper { display: flex; gap: 30px; align-items: flex-start; }
        .main-col { flex: 1; min-width: 60%; }
        
        /* Tabl√≥n Elegante y Pegajoso */
        .sidebar-col { 
            width: 380px; flex-shrink: 0; position: sticky; top: 20px; 
            background: #ffffff; padding: 25px; border-radius: 20px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.02); 
        }
        
        .nota-box { 
            background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 12px; 
            border: 1px solid #f1f5f9; border-left: 4px solid #3b82f6; /* Raya azul elegante */
            transition: all 0.2s; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .nota-box:hover { background: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-color: #e2e8f0; }
        .nota-autor { font-weight: 600; color: #64748b; font-size: 0.85em; margin-bottom: 8px; display: block; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
        .nota-texto { font-size: 1.05em; color: #1e293b; line-height: 1.4; }

        /* Scrollbar minimalista para el tablon */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f8fafc; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Elementos UI varios */
        hr { border: none; border-top: 1px solid #e2e8f0; margin: 15px 0 30px 0; }
        .badge-metodo { display: inline-block; margin-top: 5px; padding: 4px 10px; border-radius: 9999px; font-size: 0.75em; font-weight: 600; background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .btn-wsp { background-color: #10b981; color: white; padding: 10px 20px; text-decoration: none; border-radius: 9999px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 6px rgba(16,185,129,0.2); }
        .btn-wsp:hover { background-color: #059669; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(16,185,129,0.3); }

        /* Formularios UI */
        .modern-input { border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; font-family: 'Inter', sans-serif; font-size: 0.95em; outline: none; transition: all 0.2s; background: #f8fafc; width: 100%; box-sizing: border-box; }
        .modern-input:focus { border-color: #3b82f6; background: #ffffff; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .modern-select { padding: 10px 15px; border-radius: 10px; border: 1px solid #cbd5e1; background: white; font-family: 'Inter', sans-serif; font-weight: 500; outline: none; cursor: pointer; color: #334155; }
        .modern-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

        /* Panel Mec√°nico */
        .mecanico-panel { text-align: center; padding: 60px 20px; background: #ffffff; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); margin-top: 10px; border: 1px solid #e2e8f0; }
        .btn-giant { display: inline-flex; align-items: center; justify-content: center; padding: 24px 40px; font-size: 1.3em; border-radius: 16px; text-decoration: none; font-weight: 700; margin: 10px; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn-giant:hover { transform: translateY(-5px); box-shadow: 0 15px 25px rgba(0,0,0,0.1); filter: brightness(1.05); }
        .btn-vehiculo { background-color: #3b82f6; color: white; }
        .btn-presupuestos { background-color: #f97316; color: white; }
        .btn-ordenes { background-color: #0f172a; color: white; }

        @media (max-width: 1024px) {
            .layout-wrapper { flex-direction: column; }
            .sidebar-col { width: 100%; position: static; margin-bottom: 30px; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h1 style="margin: 0; font-weight: 800; letter-spacing: -0.03em; color: #0f172a;">ServiMax</h1>
            
            <a href="https://chat.whatsapp.com/DHWOfgE4866KvyJM1ZZZpB?mode=gi_t" target="_blank" class="btn-wsp">
                <span style="font-size: 1.2em;">üí¨</span> Chat del Taller
            </a>

            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="background: #f1f5f9; padding: 8px 16px; border-radius: 9999px; font-weight: 600; border: 1px solid #e2e8f0; color: #475569;">
                    üë§ {{ request.user.username|title }} 
                    {% if is_read_only_user %}<span style="color: #ef4444; font-size: 0.85em; margin-left: 5px;">(üëÅÔ∏è Modo Lectura)</span>{% endif %}
                </span>
                <form method="post" action="{% url 'logout' %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" style="background: #ef4444; color: white; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s;">Salir</button>
                </form>
            </div>
        </div>
        <hr>

        <div class="layout-wrapper">
            
            <div class="main-col">
                
                {% if request.user.is_superuser %}
                    <div class="section-panel">
                        
                        <p class="section-title">üöó Recepci√≥n y Presupuestos</p>
                        <div class="nav-buttons">
                            {% if not is_read_only_user %}
                            <a href="{% url 'ingresar_vehiculo' %}" class="nav-btn" style="background: #3b82f6;">‚ûï Ingresar Veh√≠culo</a>
                            <a href="{% url 'crear_presupuesto' %}" class="nav-btn" style="background: #f97316;">üìù Crear Presupuesto</a>
                            {% endif %}
                            <a href="{% url 'lista_presupuestos' %}" class="nav-btn" style="background: #eab308; color:#1e293b;">üìã Ver Presupuestos</a>
                        </div>

                        <p class="section-title" style="margin-top: 25px;">üîß √ìrdenes y Trabajos</p>
                        <div class="nav-buttons">
                            <a href="{% url 'lista_ordenes' %}" class="nav-btn" style="background: #0ea5e9;">üõ†Ô∏è √ìrdenes Activas</a>
                            <a href="{% url 'historial_ordenes' %}" class="nav-btn" style="background: #64748b;">üóÇÔ∏è Historial Trabajos</a>
                        </div>

                        <p class="section-title" style="margin-top: 25px;">üí∏ Gesti√≥n Financiera</p>
                        <div class="nav-buttons" style="margin-bottom: 0;">
                            {% if not is_read_only_user %}
                            <a href="{% url 'registrar_ingreso' %}" class="nav-btn" style="background: #10b981;">üí∞ Registrar Ingreso</a>
                            <a href="{% url 'anadir_gasto' %}" class="nav-btn" style="background: #ef4444;">‚ûñ A√±adir Gasto</a>
                            {% endif %}
                            <a href="{% url 'contabilidad' %}" class="nav-btn" style="background: #8b5cf6;">üìä Contabilidad</a>
                            <a href="{% url 'cuentas_por_cobrar' %}" class="nav-btn" style="background: #f43f5e;">üö® Cuentas por Cobrar</a>
                            <a href="{% url 'informe_tarjeta' %}" class="nav-btn" style="background: #0f172a;">üí≥ Bancos / TPV</a>
                        </div>

                    </div>

                    {% if not is_read_only_user %}
                        {% now "d" as dia_actual %}
                        {% if dia_actual <= "10" %}
                        <div style="background-color: #fef3c7; border-left: 5px solid #f59e0b; padding: 15px; border-radius: 10px; margin-bottom: 24px; color: #92400e;">
                            <strong style="font-weight: 700;">‚ö†Ô∏è RECORDATORIO DE PRINCIPIOS DE MES:</strong> No olvides ir a <a href="{% url 'informe_tarjeta' %}" style="color: #b45309; text-decoration: underline; font-weight: bold;">üí≥ Bancos / TPV</a> para registrar el pago de las Tarjetas.
                        </div>
                        {% endif %}
                    {% endif %}

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;">
                        <h2 style="margin: 0; font-size: 1.5em; font-weight: 700; color: #0f172a;">Resumen Financiero</h2>
                        <form method="get" style="display: flex; gap: 10px;">
                            <select name="mes" class="modern-select">
                                {% for m in meses_del_ano %}
                                    <option value="{{ m }}" {% if mes_seleccionado == m %}selected{% endif %}>Mes {{ m }}</option>
                                {% endfor %}
                            </select>
                            <select name="ano" class="modern-select">
                                {% for a in anos_disponibles %}
                                    <option value="{{ a }}" {% if ano_seleccionado == a %}selected{% endif %}>{{ a }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="nav-btn" style="background: #334155; padding: 10px 20px;">Filtrar</button>
                        </form>
                    </div>

                    <div class="dashboard-grid">
                        
                        <a href="{% url 'historial_cuenta' 'efectivo' %}" style="text-decoration: none; color: inherit;">
                            <div class="card" style="border-top-color: #10b981;">
                                <h3>Caja (Efectivo)</h3>
                                <div class="amount text-success">{{ balance_efectivo|floatformat:2 }} ‚Ç¨</div>
                                <div style="text-align: right; font-size: 0.85em; color: #64748b; font-weight: 600;">Ver historial ‚ûî</div>
                            </div>
                        </a>

                        <a href="{% url 'historial_cuenta' 'banco' %}" style="text-decoration: none; color: inherit;">
                            <div class="card" style="border-top-color: #3b82f6;">
                                <h3>Cuenta Taller (Banco)</h3>
                                <div class="amount text-primary">{{ balance_taller|floatformat:2 }} ‚Ç¨</div>
                                <div style="text-align: right; font-size: 0.85em; color: #64748b; font-weight: 600;">Ver historial ‚ûî</div>
                            </div>
                        </a>

                        <a href="{% url 'historial_cuenta' 'tarjeta1' %}" style="text-decoration: none; color: inherit;">
                            <div class="card" style="border-top-color: #ef4444;">
                                <h3>Tarjeta 1 (Revolving)</h3>
                                <div class="amount text-danger">-{{ tarjeta_1.dispuesto|floatformat:2 }} ‚Ç¨</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.8em; margin:0; color:#94a3b8; font-weight: 500;">L√≠mite: {{ tarjeta_1.limite }}‚Ç¨</span>
                                    <span style="font-size: 0.85em; color: #64748b; font-weight: 600;">Ver historial ‚ûî</span>
                                </div>
                            </div>
                        </a>

                        <a href="{% url 'historial_cuenta' 'tarjeta2' %}" style="text-decoration: none; color: inherit;">
                            <div class="card" style="border-top-color: #f59e0b;">
                                <h3>Tarjeta 2 (Mes)</h3>
                                <div class="amount text-warning">-{{ tarjeta_2.dispuesto|floatformat:2 }} ‚Ç¨</div>
                                <div style="text-align: right; font-size: 0.85em; color: #64748b; font-weight: 600;">Ver historial ‚ûî</div>
                            </div>
                        </a>

                    </div>

                    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                        <div class="section-panel" style="flex: 2; min-width: 300px; margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <h3 style="margin-top: 0; color: #0f172a;">√öltimos Movimientos</h3>
                                <a href="{% url 'historial_movimientos' %}" style="font-size: 0.9em; text-decoration: none; color: #3b82f6; font-weight: 600;">Ver todos ‚ûî</a>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <tbody>
                                    {% for mov in movimientos_recientes %}
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 12px 0; color: #64748b; font-size: 0.9em; vertical-align: top;">{{ mov.fecha|date:"d/m/Y" }}</td>
                                        <td style="padding: 12px 10px;">
                                            <span style="font-weight: 500;">{{ mov.descripcion }}</span>
                                            <br>
                                            <span class="badge-metodo">üí≥ {{ mov.metodo_pago }}</span>
                                        </td>
                                        <td style="text-align: right; font-weight: 700; font-size: 1.1em; vertical-align: middle; {% if mov.importe < 0 or mov.categoria in 'Repuestos,Sueldos,Herramientas,Suministros,Gasolina/Diesel,Otros,Compra de Consumibles,COMISIONES_INTERESES' %}color: #ef4444;{% else %}color: #10b981;{% endif %}">
                                            {% if mov.importe < 0 or mov.categoria in 'Repuestos,Sueldos,Herramientas,Suministros,Gasolina/Diesel,Otros,Compra de Consumibles,COMISIONES_INTERESES' %}-{% else %}+{% endif %}{{ mov.importe|floatformat:2 }} ‚Ç¨
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" style="text-align:center; color:#94a3b8; padding: 20px;">No hay movimientos recientes</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="section-panel" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                            <h3 style="margin-top: 0; color: #ef4444;">‚ö†Ô∏è Alertas de Stock</h3>
                            {% if alertas_stock %}
                                <ul style="padding-left: 20px; color: #ef4444; margin-bottom: 0;">
                                    {% for alerta in alertas_stock %}
                                        <li style="margin-bottom: 12px; font-weight: 500;">
                                            <strong>{{ alerta.nombre }}</strong><br>
                                            <span style="color: #64748b; font-size: 0.9em; font-weight: normal;">Quedan: {{ alerta.stock_actual }} | M√≠n: {{ alerta.minimo }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <div style="text-align: center; padding: 20px 0;">
                                    <span style="font-size: 2.5em;">‚úÖ</span>
                                    <p style="color: #10b981; font-weight: 600; margin-top: 10px;">Stock perfecto.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                {% else %}
                    <div class="mecanico-panel">
                        <h2 style="color: #0f172a; font-size: 2.2em; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 30px;">üõ†Ô∏è Panel de Trabajo</h2>
                        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
                            <a href="{% url 'ingresar_vehiculo' %}" class="btn-giant btn-vehiculo">
                                üöó Nuevo Veh√≠culo
                            </a>
                            <a href="{% url 'lista_presupuestos' %}" class="btn-giant btn-presupuestos">
                                üìã Presupuestos
                            </a>
                            <a href="{% url 'lista_ordenes' %}" class="btn-giant btn-ordenes">
                                üõ†Ô∏è Ver Taller
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="sidebar-col">
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #0f172a; font-size: 1.4em; font-weight: 800;">üìã Tareas y Avisos</h2>
                    <a href="{% url 'historial_notas' %}" style="color: #3b82f6; text-decoration: none; font-weight: 600; font-size: 0.85em; transition: 0.2s;">Ver Historial ‚ûî</a>
                </div>
                
                <form action="{% url 'agregar_nota' %}" method="post" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
                    {% csrf_token %}
                    <textarea name="texto" class="modern-input" placeholder="Escribe un aviso para el equipo..." required style="resize: none; height: 85px;"></textarea>
                    <button type="submit" style="background: #0f172a; color: white; font-weight: 600; font-size: 1.05em; border: none; padding: 14px; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚ûï A√±adir Tarea</button>
                </form>

                <div class="custom-scroll" style="max-height: 550px; overflow-y: auto; padding-right: 8px;">
                    {% for nota in notas_tablon %}
                        <div class="nota-box">
                            <div style="width: 82%;">
                                <span class="nota-autor">üë§ {{ nota.autor.username|title }} &nbsp;‚Ä¢&nbsp; <span style="font-weight: normal; color: #94a3b8;">{{ nota.fecha_creacion|date:"d/m/y H:i" }}</span></span>
                                <div class="nota-texto">{{ nota.texto }}</div>
                            </div>
                            {% if request.user == nota.autor or request.user.is_superuser %}
                            <form action="{% url 'completar_nota' nota.id %}" method="post" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit" title="Marcar como completada" style="background: white; color: #10b981; border: 2px solid #10b981; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">‚úì</button>
                            </form>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div style="text-align: center; padding: 40px 10px; background: #f8fafc; border-radius: 12px; border: 1px dashed #cbd5e1;">
                            <p style="font-size: 2.5em; margin: 0;">üéâ</p>
                            <p style="color: #64748b; font-weight: 600; font-size: 1.1em; margin-top: 10px;">Todo el trabajo al d√≠a.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

        </div> </div> </body>
</html>