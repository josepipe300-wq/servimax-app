<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Presupuesto #{{ presupuesto_existente.id }} - ServiMax</title>
    <link rel="stylesheet" href="{% static 'taller/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
</head>
<body>
    <div class="form-container">
        <div class="header">
            <h1>Editando Presupuesto #{{ presupuesto_existente.id }}</h1>
            <a href="{% url 'detalle_presupuesto' presupuesto_existente.id %}" class="back-btn">← Cancelar y Volver</a>
        </div>
        <hr>

        <form id="presupuesto-form" action="{% url 'editar_presupuesto' presupuesto_existente.id %}" method="post">
            {% csrf_token %}

            <div class="section">
                <h2>Cliente</h2>
                <label for="cliente_existente">Seleccionar Cliente Existente:</label>
                <select id="cliente_existente" name="cliente_existente">
                    <option value="">--- O Crear Nuevo Cliente Abajo ---</option>
                    {% for c_data in clientes_data %}
                        {% with cliente=c_data.cliente %}
                        <option value="{{ cliente.id }}" 
                                data-cliente-json="{{ c_data.cliente_data_json|escape }}"
                                {% if presupuesto_existente.cliente.id == cliente.id %}selected{% endif %}>
                            {{ cliente.nombre }} ({{ cliente.telefono }})
                        </option>
                        {% endwith %}
                    {% endfor %}
                </select>

                <div id="nuevo_cliente_fields">
                    <label for="cliente_nombre">Nombre o Razón Social:</label>
                    <input type="text" id="cliente_nombre" name="cliente_nombre" value="{{ presupuesto_existente.cliente.nombre }}">
                    <label for="cliente_telefono">Teléfono:</label>
                    <input type="text" id="cliente_telefono" name="cliente_telefono" value="{{ presupuesto_existente.cliente.telefono }}">

                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Datos Fiscales (Para Facturas)</h3>
                
                    <div class="address-grid">
                        <div>
                            <label for="cliente_tipo_documento">Tipo Doc.:</label>
                            <select id="cliente_tipo_documento" name="cliente_tipo_documento">
                                <option value="DNI" {% if presupuesto_existente.cliente.tipo_documento == 'DNI' %}selected{% endif %}>DNI</option>
                                <option value="NIE" {% if presupuesto_existente.cliente.tipo_documento == 'NIE' %}selected{% endif %}>NIE</option>
                                <option value="NIF" {% if presupuesto_existente.cliente.tipo_documento == 'NIF' %}selected{% endif %}>NIF (Empresas)</option>
                            </select>
                        </div>
                        <div>
                            <label for="cliente_documento_fiscal">Nº Documento:</label>
                            <input type="text" id="cliente_documento_fiscal" name="cliente_documento_fiscal" value="{{ presupuesto_existente.cliente.documento_fiscal|default:'' }}">
                        </div>
                    </div>

                    <label for="cliente_direccion_fiscal">Dirección Fiscal (Calle, nº):</label>
                    <input type="text" id="cliente_direccion_fiscal" name="cliente_direccion_fiscal" value="{{ presupuesto_existente.cliente.direccion_fiscal|default:'' }}">
                    
                    <div class="address-grid">
                        <div>
                            <label for="cliente_codigo_postal_fiscal">Código Postal:</label>
                            <input type="text" id="cliente_codigo_postal_fiscal" name="cliente_codigo_postal_fiscal" value="{{ presupuesto_existente.cliente.codigo_postal_fiscal|default:'' }}">
                        </div>
                        <div>
                            <label for="cliente_ciudad_fiscal">Población:</label>
                            <input type="text" id="cliente_ciudad_fiscal" name="cliente_ciudad_fiscal" value="{{ presupuesto_existente.cliente.ciudad_fiscal|default:'' }}">
                        </div>
                    </div>
                    <label for="cliente_provincia_fiscal">Provincia:</label>
                    <input type="text" id="cliente_provincia_fiscal" name="cliente_provincia_fiscal" value="{{ presupuesto_existente.cliente.provincia_fiscal|default:'TARRAGONA' }}">
                </div>
            </div>

            <div class="section">
                <h2>Vehículo</h2>
                 <label for="vehiculo_existente">Seleccionar Vehículo Existente (del cliente):</label>
                 <select id="vehiculo_existente" name="vehiculo_existente">
                    <option value="">--- O Introducir Datos Abajo ---</option>
                    {% for vehiculo in vehiculos %}
                        <option value="{{ vehiculo.id }}" data-cliente="{{ vehiculo.cliente.id }}" style="display: none;" {% if presupuesto_existente.vehiculo.id == vehiculo.id %}selected{% endif %}>
                            {{ vehiculo }}
                        </option>
                    {% endfor %}
                </select>

                 <div id="nuevo_vehiculo_fields">
                    <label for="matricula_nueva">Matrícula Nueva:</label>
                    <input type="text" id="matricula_nueva" name="matricula_nueva" value="{{ presupuesto_existente.matricula_nueva|default:'' }}">
                    <label for="marca_nueva">Marca Nueva:</label>
                    <input type="text" id="marca_nueva" name="marca_nueva" value="{{ presupuesto_existente.marca_nueva|default:'' }}">
                    <label for="modelo_nuevo">Modelo Nuevo:</label>
                    <input type="text" id="modelo_nuevo" name="modelo_nuevo" value="{{ presupuesto_existente.modelo_nuevo|default:'' }}">
                 </div>
            </div>

            <div class="section">
                <h2>Descripción del Trabajo</h2>
                <label for="problema_o_trabajo">Problema / Tareas a presupuestar:</label>
                <textarea id="problema_o_trabajo" name="problema_o_trabajo" required>{{ presupuesto_existente.problema_o_trabajo }}</textarea>
            </div>

            <div class="section">
                <h2>Líneas del Presupuesto</h2>
                <div id="lineas-container">
                </div>
                <button type="button" class="btn-add" id="add-linea-btn">+ Añadir Línea</button>
            </div>

            <button type="submit" class="btn-submit-yellow">Guardar Cambios</button>
        </form>
    </div>

    <script>
        // --- JAVASCRIPT ACTUALIZADO ---
        const clienteSelect = document.getElementById('cliente_existente');
        const nuevoClienteFields = document.getElementById('nuevo_cliente_fields');
        const nombreClienteInput = document.getElementById('cliente_nombre');
        const telefonoClienteInput = document.getElementById('cliente_telefono');
        const tipoDocumentoInput = document.getElementById('cliente_tipo_documento');
        const documentoFiscalInput = document.getElementById('cliente_documento_fiscal');
        const direccionFiscalInput = document.getElementById('cliente_direccion_fiscal');
        const codigoPostalFiscalInput = document.getElementById('cliente_codigo_postal_fiscal');
        const ciudadFiscalInput = document.getElementById('cliente_ciudad_fiscal');
        const provinciaFiscalInput = document.getElementById('cliente_provincia_fiscal');
        const vehiculoSelect = document.getElementById('vehiculo_existente');
        const nuevoVehiculoFields = document.getElementById('nuevo_vehiculo_fields');
        const lineasContainer = document.getElementById('lineas-container');
        const addLineaBtn = document.getElementById('add-linea-btn');
        const lineasExistentes = JSON.parse('{{ lineas_existentes_json|escapejs }}');

        function handleClienteChange() {
            const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            const clienteSeleccionado = clienteSelect.value;

            if (clienteSeleccionado) {
                nuevoClienteFields.classList.add('hidden');
                const clienteData = JSON.parse(selectedOption.getAttribute('data-cliente-json'));
                nombreClienteInput.value = selectedOption.text.split(' (')[0].trim();
                telefonoClienteInput.value = selectedOption.text.match(/\(([^)]+)\)/)[1];
                tipoDocumentoInput.value = clienteData.tipo_documento || 'DNI';
                documentoFiscalInput.value = clienteData.documento_fiscal || '';
                direccionFiscalInput.value = clienteData.direccion_fiscal || '';
                codigoPostalFiscalInput.value = clienteData.codigo_postal_fiscal || '';
                ciudadFiscalInput.value = clienteData.ciudad_fiscal || '';
                provinciaFiscalInput.value = clienteData.provincia_fiscal || 'TARRAGONA';
            } else {
                nuevoClienteFields.classList.remove('hidden');
                // Al deseleccionar, restauramos los valores originales del presupuesto que se está editando
                nombreClienteInput.value = "{{ presupuesto_existente.cliente.nombre }}";
                telefonoClienteInput.value = "{{ presupuesto_existente.cliente.telefono }}";
                tipoDocumentoInput.value = "{{ presupuesto_existente.cliente.tipo_documento|default:'DNI' }}";
                documentoFiscalInput.value = "{{ presupuesto_existente.cliente.documento_fiscal|default:'' }}";
                direccionFiscalInput.value = "{{ presupuesto_existente.cliente.direccion_fiscal|default:'' }}";
                codigoPostalFiscalInput.value = "{{ presupuesto_existente.cliente.codigo_postal_fiscal|default:'' }}";
                ciudadFiscalInput.value = "{{ presupuesto_existente.cliente.ciudad_fiscal|default:'' }}";
                provinciaFiscalInput.value = "{{ presupuesto_existente.cliente.provincia_fiscal|default:'TARRAGONA' }}";
            }
            filterVehiculos(clienteSeleccionado);
        }

        function handleVehiculoChange() {
            if (vehiculoSelect.value) {
                nuevoVehiculoFields.classList.add('hidden');
                document.getElementById('matricula_nueva').value = '';
                document.getElementById('marca_nueva').value = '';
                document.getElementById('modelo_nuevo').value = '';
            } else {
                nuevoVehiculoFields.classList.remove('hidden');
                // Restaurar datos originales si se deselecciona
                document.getElementById('matricula_nueva').value = "{{ presupuesto_existente.matricula_nueva|default:'' }}";
                document.getElementById('marca_nueva').value = "{{ presupuesto_existente.marca_nueva|default:'' }}";
                document.getElementById('modelo_nuevo').value = "{{ presupuesto_existente.modelo_nuevo|default:'' }}";
            }
        }

        function filterVehiculos(selectedClienteId) {
            for (const option of vehiculoSelect.options) {
                if (option.value === "") continue;
                const vehiculoClienteId = option.getAttribute('data-cliente');
                const shouldDisplay = !selectedClienteId || (vehiculoClienteId === selectedClienteId);
                option.style.display = shouldDisplay ? 'block' : 'none';
            }
             const currentSelectedOption = vehiculoSelect.options[vehiculoSelect.selectedIndex];
             if (currentSelectedOption && currentSelectedOption.value !== "" && currentSelectedOption.getAttribute('data-cliente') !== selectedClienteId && selectedClienteId !== "") {
                  vehiculoSelect.value = ""; 
             }
            handleVehiculoChange();
        }

        function addLinea(lineaData = null) {
            const newLinea = document.createElement('div');
            newLinea.classList.add('linea-item');
            let tipoSelectHTML = `<select name="linea_tipo" required><option value="">Tipo...</option>`;
            {% for value, name in tipos_linea %}
            tipoSelectHTML += `<option value="{{ value }}" ${lineaData && lineaData.tipo === '{{ value }}' ? 'selected' : ''}>{{ name }}</option>`;
            {% endfor %}
            tipoSelectHTML += `</select>`;
            const descripcionInput = `<input type="text" name="linea_descripcion" placeholder="Descripción" value="${lineaData ? lineaData.descripcion : ''}" required>`;
            const cantidadInput = `<input type="number" step="0.01" min="0" name="linea_cantidad" placeholder="Cant." value="${lineaData ? lineaData.cantidad : '1'}" required>`;
            const precioInput = `<input type="number" step="0.01" min="0" name="linea_precio_unitario" placeholder="Precio Unit. (€)" value="${lineaData ? lineaData.precio_unitario_estimado : ''}" required>`;
            const removeButton = `<button type="button" class="btn-remove" onclick="removeLinea(this)">X</button>`;
            newLinea.innerHTML = tipoSelectHTML + descripcionInput + cantidadInput + precioInput + removeButton;
            lineasContainer.appendChild(newLinea);
        }

        function removeLinea(button) {
            button.closest('.linea-item').remove();
        }

        clienteSelect.addEventListener('change', handleClienteChange);
        vehiculoSelect.addEventListener('change', handleVehiculoChange);
        addLineaBtn.addEventListener('click', () => addLinea());

        document.addEventListener('DOMContentLoaded', () => {
            handleClienteChange(); 
            if (lineasExistentes && lineasExistentes.length > 0) {
                lineasExistentes.forEach(linea => addLinea(linea));
            } else {
                addLinea(); 
            }
            // Asegurarse de que los campos de vehículo nuevo se muestren si no hay vehículo seleccionado
            handleVehiculoChange();
        });
    </script>
</body>
</html>