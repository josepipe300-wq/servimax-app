<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Tarjetas - ServiMax</title>
    
    <link rel="stylesheet" href="{% static 'taller/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
    <style>
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .credit-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid #007bff; }
        .credit-card.roja { border-top-color: #dc3545; }
        .credit-card.amarilla { border-top-color: #ffc107; }
        
        .cc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .cc-header h3 { margin: 0; font-size: 1.2em; color: #333; }
        
        .cc-balance { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .cc-deuda { color: #dc3545; }
        
        .cc-details { display: flex; justify-content: space-between; font-size: 0.9em; color: #666; margin-bottom: 15px; }
        
        /* Barra de progreso de l√≠mite */
        .progress-container { width: 100%; background-color: #e9ecef; border-radius: 5px; height: 10px; margin-bottom: 5px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 5px; background-color: #28a745; }
        .progress-bar.warning { background-color: #ffc107; }
        .progress-bar.danger { background-color: #dc3545; }

        .action-bar { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: center; border: 1px dashed #ccc;}
        .btn-pago-tarjeta { background-color: #007bff; color: white; padding: 12px 25px; border-radius: 5px; text-decoration: none; font-weight: bold; font-size: 1.1em; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,123,255,0.3); }
        .btn-pago-tarjeta:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de Control de Tarjetas</h1>
            <a href="{% url 'home' %}" class="back-btn">‚Üê Volver al Inicio</a>
        </div>
        <hr>

        <div class="action-bar">
            <a href="{% url 'registrar_pago_tarjeta' %}" class="btn-pago-tarjeta">
                <span>üí≥ Registrar Pago de Tarjeta a Fin de Mes</span>
            </a>
        </div>

        <div class="cards-grid">
            <div class="credit-card roja">
                <div class="cc-header">
                    <h3>Tarjeta 1 (Revolving)</h3>
                    <span class="badge bg-danger" style="color:white; padding: 5px 8px; border-radius:4px; font-size:0.8em;">L√≠mite: {{ tarjeta_1.limite }}‚Ç¨</span>
                </div>
                <div class="cc-details">
                    <span>Deuda Acumulada:</span>
                </div>
                <div class="cc-balance cc-deuda">{{ tarjeta_1.dispuesto|floatformat:2 }} ‚Ç¨</div>
                
                {% widthratio tarjeta_1.dispuesto tarjeta_1.limite 100 as porcentaje %}
                <div class="progress-container">
                    <div class="progress-bar {% if porcentaje > '80' %}danger{% elif porcentaje > '50' %}warning{% endif %}" style="width: {% if porcentaje > '100' %}100{% else %}{{ porcentaje }}{% endif %}%;"></div>
                </div>
                <div class="cc-details" style="margin-top: 5px;">
                    <span>Disponible: <strong style="color: #28a745;">{{ tarjeta_1.disponible|floatformat:2 }} ‚Ç¨</strong></span>
                </div>
                <a href="{% url 'historial_cuenta' 'tarjeta1' %}" style="display:block; text-align:center; margin-top: 10px; font-size:0.9em; text-decoration:none; color:#007bff;">Ver todos los tickets ‚Üí</a>
            </div>

            <div class="credit-card amarilla">
                <div class="cc-header">
                    <h3>Tarjeta 2 (Pago Total)</h3>
                    <span class="badge bg-warning" style="color:#333; padding: 5px 8px; border-radius:4px; font-size:0.8em;">L√≠mite: {{ tarjeta_2.limite }}‚Ç¨</span>
                </div>
                <div class="cc-details">
                    <span>Pr√≥ximo Cargo al Banco:</span>
                </div>
                <div class="cc-balance cc-deuda">{{ tarjeta_2.dispuesto|floatformat:2 }} ‚Ç¨</div>
                
                {% widthratio tarjeta_2.dispuesto tarjeta_2.limite 100 as porcentaje2 %}
                <div class="progress-container">
                    <div class="progress-bar {% if porcentaje2 > '80' %}danger{% elif porcentaje2 > '50' %}warning{% endif %}" style="width: {% if porcentaje2 > '100' %}100{% else %}{{ porcentaje2 }}{% endif %}%;"></div>
                </div>
                <div class="cc-details" style="margin-top: 5px;">
                    <span>Disponible: <strong style="color: #28a745;">{{ tarjeta_2.disponible|floatformat:2 }} ‚Ç¨</strong></span>
                </div>
                <a href="{% url 'historial_cuenta' 'tarjeta2' %}" style="display:block; text-align:center; margin-top: 10px; font-size:0.9em; text-decoration:none; color:#007bff;">Ver todos los tickets ‚Üí</a>
            </div>
        </div>

        <h3 style="margin-top: 40px; border-bottom: 2px solid #eee; padding-bottom: 10px;">Intereses y Cierres Autom√°ticos</h3>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Fecha Cierre</th>
                    <th>Tarjeta</th>
                    <th>Pago Realizado</th>
                    <th>Deuda Reportada</th>
                    <th>Intereses Detectados</th>
                    <th>Acci√≥n</th> </tr>
            </thead>
            <tbody>
                {% for cierre in cierres %}
                <tr>
                    <td>{{ cierre.fecha_cierre|date:"d/m/Y" }}</td>
                    <td><strong>{{ cierre.get_tarjeta_display }}</strong></td>
                    <td style="color: #28a745;">{{ cierre.pago_cuota|floatformat:2 }} ‚Ç¨</td>
                    <td>{{ cierre.saldo_deuda_banco|floatformat:2 }} ‚Ç¨</td>
                    <td style="color: #dc3545; font-weight:bold;">
                        {% if cierre.intereses_calculados > 0 %}
                            ‚ö†Ô∏è {{ cierre.intereses_calculados|floatformat:2 }} ‚Ç¨
                        {% else %}
                            0.00 ‚Ç¨
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        <form method="post" action="{% url 'eliminar_cierre_tarjeta' cierre.id %}" onsubmit="return confirm('¬øSeguro que quieres DESHACER este cierre? Se devolver√° el dinero a la cuenta del taller y se borrar√°n los gastos de inter√©s de forma autom√°tica.');">
                            {% csrf_token %}
                            <button type="submit" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 0;" title="Deshacer cierre">üóëÔ∏è</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; color: #666; padding: 20px;">A√∫n no se han registrado pagos de fin de mes.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>