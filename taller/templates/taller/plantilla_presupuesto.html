<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Presupuesto #{{ presupuesto.id }}</title>
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
    <style>
        @page { size: a4 portrait; margin: 1.5cm; }
        body { font-family: sans-serif; font-size: 11px; }

        .header-container {
            position: relative;
            border-bottom: 2px solid #f2f2f2;
            margin-bottom: 20px;
            overflow: auto;
        }
        .info-documento {
            text-align: right;
            width: 100%; 
        }

        .cliente-info { border: 1px solid #ccc; padding: 15px; border-radius: 5px; margin-bottom: 20px;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .totales { margin-top: 20px; text-align: right; width: 250px; margin-left: auto; }
        .totales p { margin: 5px 0; }
        .nota { margin-top: 30px; font-size: 10px; color: #555; border-top: 1px solid #eee; padding-top: 10px;}
        .cliente-info p { margin: 4px 0; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div class="info-documento">
                <h2>Presupuesto</h2>
                <p><strong>Número:</strong> {{ presupuesto.id }}<br><strong>Fecha:</strong> {{ presupuesto.fecha_creacion|date:"d/m/Y" }}</p>
                <p>
                    <strong>Taller ServiMax</strong><br>
                    <em>Honestidad y Calidad</em><br>
                    
                    {# --- LÓGICA: Solo mostrar datos fiscales del taller si hay IVA --- #}
                    {% if presupuesto.aplicar_iva %}
                    <strong>NIE:</strong> Y9305858A<br>
                    <em>JOSE EVARDID MENDIETA CORTES</em><br>
                    Carrer del Terrer 18<br>
                    43840 Salou, Tarragona<br>
                    {% endif %}
                    {# ----------------------------------------------------------- #}
                    
                    <strong>Teléfono:</strong> 642 99 30 63
                </p>
            </div>
        </div>

        <div class="cliente-info">
            <h3>Datos del Cliente</h3>
            <p>
                <strong>Nombre:</strong> {{ presupuesto.cliente.nombre }}<br>
                <strong>Teléfono:</strong> {{ presupuesto.cliente.telefono }}<br>
                
                {# --- LÓGICA: Solo mostrar datos fiscales del cliente si hay IVA --- #}
                {% if presupuesto.aplicar_iva %}
                <strong>{{ presupuesto.cliente.get_tipo_documento_display|default:'DNI' }}:</strong> {{ presupuesto.cliente.documento_fiscal|default:'---' }}<br>
                <strong>Dirección:</strong> {{ presupuesto.cliente.direccion_fiscal|default:'---' }}<br>
                {{ presupuesto.cliente.codigo_postal_fiscal|default:'' }} {{ presupuesto.cliente.ciudad_fiscal|default:'' }} ({{ presupuesto.cliente.provincia_fiscal|default:'TARRAGONA' }})
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 8px 0;">
                {% endif %}
                {# ------------------------------------------------------------ #}

                <strong>Vehículo:</strong>
                {% if presupuesto.vehiculo %}
                    {{ presupuesto.vehiculo.marca }} {{ presupuesto.vehiculo.modelo }} - {{ presupuesto.vehiculo.matricula }}
                    {% if presupuesto.vehiculo.kilometraje %}({{ presupuesto.vehiculo.kilometraje }} km){% endif %}
                {% elif presupuesto.matricula_nueva %}
                    {{ presupuesto.marca_nueva }} {{ presupuesto.modelo_nuevo }} - {{ presupuesto.matricula_nueva }} (Nuevo)
                {% else %}
                    No especificado
                {% endif %}
                <br>
                <strong>Trabajo Solicitado:</strong> {{ presupuesto.problema_o_trabajo|default:"No especificado" }}
            </p>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th style="text-align: right; width: 80px;">Cantidad</th>
                    <th style="text-align: right; width: 100px;">Precio Unit. Est.</th>
                    <th style="text-align: right; width: 100px;">Total Est.</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in lineas %}
                <tr>
                    <td>{{ linea.descripcion }}</td>
                    <td style="text-align: right;">{{ linea.cantidad|floatformat:2 }}</td>
                    <td style="text-align: right;">{{ linea.precio_unitario_estimado|floatformat:2 }} €</td>
                    <td style="text-align: right;">{{ linea.total_linea_estimado|floatformat:2 }} €</td>
                </tr>
                {% empty %}
                 <tr>
                    <td colspan="4" style="text-align: center;">No hay líneas en este presupuesto.</td>
                 </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="totales">
            {# --- LÓGICA: Desglose solo si hay IVA --- #}
            {% if presupuesto.aplicar_iva %}
                <p><strong>Subtotal:</strong> {{ presupuesto.subtotal|floatformat:2 }} €</p>
                <p><strong>IVA (21%):</strong> {{ presupuesto.iva|floatformat:2 }} €</p>
                <hr>
            {% endif %}
            <h3 style="margin-bottom: 5px;"><strong>TOTAL ESTIMADO:</strong> {{ presupuesto.total_estimado|floatformat:2 }} €</h3>
        </div>

        <div class="nota">
            <p>Este presupuesto tiene carácter informativo y no contractual. Los precios pueden variar en función de imprevistos o cambios solicitados durante la reparación. Validez del presupuesto: 30 días.</p>
        </div>
    </div>
</body>
</html>