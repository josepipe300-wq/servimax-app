<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle Orden #{{ orden.id }} - ServiMax</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1, h2, h3, h4 { color: #333; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .info-item { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .info-item strong { display: block; margin-bottom: 5px; color: #555; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .items-table th, .items-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .items-table th { background-color: #e9ecef; }
        .status-form, .factura-form { margin-top: 30px; padding: 20px; background-color: #e9ecef; border-radius: 5px; }
        .status-form select, .factura-form input, .factura-form select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .status-form button, .factura-form button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .factura-form button, .btn-pdf { background-color: #28a745; width: 100%; padding: 15px; font-size: 1.2em; text-decoration: none; display: block; text-align: center; color: white; border-radius: 4px;}
        .header { display: flex; justify-content: space-between; align-items: center; }
        .back-btn { padding: 10px 15px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px; }
        .checkbox-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-container input { width: auto; }
        .financial-summary { border: 2px solid #007bff; padding: 15px; margin-top: 20px; border-radius: 5px; }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-gallery img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Detalle de la Orden #{{ orden.id }}</h1>
            <a href="{% url 'lista_ordenes' %}" class="back-btn">‚Üê Volver a la Lista</a>
        </div>
        <p><strong>Estado Actual:</strong> <span style="background-color: #007bff; color: white; padding: 5px 10px; border-radius: 5px;">{{ orden.estado }}</span></p>
        <hr>

        {% if factura %}
            <div class="financial-summary">
                <h3>Resumen Financiero</h3>
                <p><strong>Total Factura:</strong> {{ factura.total_final|floatformat:2 }} ‚Ç¨</p>
                <p><strong>Total Pagado (Abonos):</strong> {{ abonos|floatformat:2 }} ‚Ç¨</p>
                <p><strong>Pendiente de Pago:</strong> <strong style="color: #dc3545;">{{ pendiente_pago|floatformat:2 }} ‚Ç¨</strong></p>
            </div>
        {% endif %}

        <div class="info-grid">
            <div class="info-item"><strong>Cliente:</strong> {{ orden.cliente.nombre }} ({{ orden.cliente.telefono }})</div>
            <div class="info-item"><strong>Veh√≠culo:</strong> {{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }} ({{ orden.vehiculo.matricula }})</div>
        </div>
        <div class="info-item" style="margin-top: 20px;"><strong>Problema Reportado:</strong><p>{{ orden.problema|linebreaks }}</p></div>
        
        <div class="info-item" style="margin-top: 20px;">
            <strong>Fotos de la Entrada</strong>
            <div class="photo-gallery">
                {% for foto in orden.fotos.all %}
                    <a href="{{ foto.imagen.url }}" target="_blank">
                        <img src="{{ foto.imagen.url }}" alt="{{ foto.descripcion }}">
                    </a>
                {% empty %}
                    <p>No se subieron fotos para esta orden.</p>
                {% endfor %}
            </div>
        </div>

        <div class="status-form">
            <h2>Actualizar Estado</h2>
            <form action="{% url 'detalle_orden' orden.id %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="estado">
                <select name="nuevo_estado">
                    {% for value, name in orden.ESTADO_CHOICES %}<option value="{{ value }}" {% if orden.estado == value %}selected{% endif %}>{{ name }}</option>{% endfor %}
                </select>
                <button type="submit">Actualizar Estado</button>
            </form>
        </div>

        <div style="margin-top: 30px;">
            <h2>Gastos Asociados (Costes del Taller)</h2>
            <h3>Repuestos</h3>
            <table class="items-table">
                {% for repuesto in repuestos %}<tr><td>{{ repuesto.descripcion }}</td><td>{{ repuesto.importe|floatformat:2 }} ‚Ç¨</td></tr>{% empty %}<tr><td>No hay repuestos asociados.</td></tr>{% endfor %}
            </table>
            <h3 style="margin-top: 15px;">Trabajos Externos (Otros)</h3>
            <table class="items-table">
                {% for gasto in gastos_otros %}<tr><td>{{ gasto.descripcion }}</td><td>{{ gasto.importe|floatformat:2 }} ‚Ç¨</td></tr>{% empty %}<tr><td>No hay trabajos externos asociados.</td></tr>{% endfor %}
            </table>
        </div>

        {% if factura %}
            <div class="factura-form">
                <h2>Factura Generada</h2>
                <a href="{% url 'ver_factura_pdf' factura.id %}" class="btn-pdf" target="_blank">üìÑ Ver Factura PDF</a>
                <a href="{% url 'editar_factura' factura.id %}" class="btn-pdf" style="background-color: #ffc107; color: #333; margin-top: 10px;">Modificar Factura</a>
            </div>
        {% else %}
            <div class="factura-form">
                <h2>Generar Factura</h2>
                <form id="factura-form" action="{% url 'generar_factura' orden.id %}" method="post">
                    {% csrf_token %}
                    <h4>Repuestos</h4>
                    {% for repuesto in repuestos %}
                        <label>{{ repuesto.descripcion }} (Coste: {{ repuesto.importe|floatformat:2 }}‚Ç¨)</label>
                        <input type="number" step="0.01" name="pvp_repuesto_{{ repuesto.id }}" class="pvp-input" data-coste="{{ repuesto.importe }}" placeholder="PVP Repuesto">
                    {% endfor %}

                    <h4>Trabajos Externos</h4>
                    {% for gasto in gastos_otros %}
                        <label>{{ gasto.descripcion }} (Coste: {{ gasto.importe|floatformat:2 }}‚Ç¨)</label>
                        <input type="number" step="0.01" name="pvp_otro_{{ gasto.id }}" class="pvp-input" data-coste="{{ gasto.importe }}" placeholder="PVP Trabajo Externo">
                    {% endfor %}

                    <h4>Consumibles</h4>
                    <div class="checkbox-container">
                        <input type="checkbox" id="add_consumible" name="add_consumible">
                        <label for="add_consumible">A√±adir consumible (aceite, etc.)</label>
                    </div>
                    <div id="consumible_campos" style="display: none;">
                        <select name="tipo_consumible">
                            <option value="">Selecciona tipo</option>
                            {% for tipo in tipos_consumible %}<option value="{{ tipo.id }}">{{ tipo.nombre }}</option>{% endfor %}
                        </select>
                        <input type="number" step="0.01" name="consumible_cantidad" placeholder="Cantidad usada (Ej: 4.5)">
                        <input type="number" step="0.01" name="consumible_pvp_total" placeholder="Precio Total a Cobrar (‚Ç¨)">
                    </div>
                    
                    <h4>Mano de Obra</h4>
                    <div id="mano-de-obra-container">
                        <div class="mano-obra-item">
                            <input type="text" name="mano_obra_desc" placeholder="Descripci√≥n del trabajo" required>
                            <input type="number" step="0.01" name="mano_obra_importe" placeholder="Importe (‚Ç¨)" required>
                        </div>
                    </div>
                    <button type="button" id="add-mano-obra">+ A√±adir l√≠nea de trabajo</button>
                    
                    <h4 style="margin-top: 20px;">Finalizar</h4>
                    <div class="checkbox-container">
                        <input type="checkbox" id="aplicar_iva" name="aplicar_iva">
                        <label for="aplicar_iva">Aplicar IVA (21%)</label>
                    </div>
                    <hr>
                    <button type="submit">Calcular y Crear Factura</button>
                </form>
            </div>
        {% endif %}
    </div>

    <script>
        // L√≥gica para mostrar/ocultar campos de consumibles
        document.getElementById('add_consumible').addEventListener('change', (e) => {
            document.getElementById('consumible_campos').style.display = e.target.checked ? 'block' : 'none';
        });

        // L√≥gica para a√±adir nuevas l√≠neas de mano de obra
        document.getElementById('add-mano-obra').addEventListener('click', () => {
            const container = document.getElementById('mano-de-obra-container');
            const newItem = document.createElement('div');
            newItem.classList.add('mano-obra-item');
            newItem.innerHTML = `
                <input type="text" name="mano_obra_desc" placeholder="Descripci√≥n del trabajo">
                <input type="number" step="0.01" name="mano_obra_importe" placeholder="Importe (‚Ç¨)">
            `;
            container.appendChild(newItem);
        });
    </script>
</body>
</html>