<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% if factura.es_factura %}Factura{% else %}Recibo{% endif %} #{{ factura.id }}</title>
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
    <style>
        @page { size: a4 portrait; margin: 1.5cm; }
        body { font-family: sans-serif; font-size: 11px; }

        /* --- ESTRUCTURA DE CABECERA SIN LOGO --- */
        .header-container {
            position: relative;
            /* No se necesita altura fija */
            border-bottom: 2px solid #f2f2f2;
            margin-bottom: 20px;
            overflow: auto;
        }
        .info-factura {
            text-align: right;
            width: 100%; /* Ocupar todo el ancho */
        }

        .cliente-info { border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .totales { margin-top: 20px; text-align: right; width: 250px; margin-left: auto; }
        .totales p { margin: 5px 0; }
        
        /* --- ESTILO AÑADIDO PARA LOS DATOS DEL CLIENTE --- */
        .cliente-info p { margin: 4px 0; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
             {# El div del logo ha sido completamente eliminado #}
            <div class="info-factura">
                <h2>{% if factura.es_factura %}Factura{% else %}Recibo{% endif %}</h2>
                <p><strong>Número:</strong> {{ factura.id }}<br><strong>Fecha:</strong> {{ factura.fecha_emision|date:"d/m/Y" }}</p>
                <p>
                    <strong>Taller ServiMax</strong><br>
                    <em>Honestidad y Calidad</em><br>
                    <strong>NIE:</strong> Y9305858A<br>
                    <em>JOSE EVARDID MENDIETA CORTES</em><br>
                    Carrer del Terrer 18<br>
                    43840 Salou, Tarragona<br>
                    <strong>Teléfono:</strong> 642 99 30 63
                </p>
            </div>
        </div>

        <div class="cliente-info">
            <h3>Datos del Cliente</h3>
            <p>
                <strong>Nombre:</strong> {{ cliente.nombre }}<br>
                <strong>Teléfono:</strong> {{ cliente.telefono }}<br>
                
                {# --- INICIO DE LA MODIFICACIÓN --- #}
                <strong>{{ cliente.get_tipo_documento_display|default:'DNI' }}:</strong> {{ cliente.documento_fiscal|default:'---' }}<br>
                <strong>Dirección:</strong> {{ cliente.direccion_fiscal|default:'---' }}<br>
                {{ cliente.codigo_postal_fiscal|default:'' }} {{ cliente.ciudad_fiscal|default:'' }} ({{ cliente.provincia_fiscal|default:'TARRAGONA' }})
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 8px 0;">
                {# --- FIN DE LA MODIFICACIÓN --- #}
                
                <strong>Vehículo:</strong> {{ vehiculo.marca }} {{ vehiculo.modelo }} - {{ vehiculo.matricula }}<br>
                <strong>Kilometraje:</strong> {{ vehiculo.kilometraje }} km
            </p>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th style="text-align: right; width: 80px;">Cantidad</th>
                    <th style="text-align: right; width: 100px;">Precio Unit.</th>
                    <th style="text-align: right; width: 100px;">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in lineas %}
                <tr>
                    <td>{{ linea.descripcion }}</td>
                    <td style="text-align: right;">{{ linea.cantidad|floatformat:2 }}</td>
                    <td style="text-align: right;">{{ linea.precio_unitario|floatformat:2 }} €</td>
                    <td style="text-align: right;">{{ linea.total_linea|floatformat:2 }} €</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if factura.notas_cliente %}
        <div class="notas-cliente" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; page-break-inside: avoid;">
            <strong>Notas Adicionales:</strong>
            <p style="font-size: 10px; white-space: pre-wrap; color: #333;">{{ factura.notas_cliente }}</p>
        </div>
        {% endif %}
        <div class="totales" style="page-break-inside: avoid;">
            {% if factura.es_factura %}
                <p><strong>Subtotal:</strong> {{ factura.subtotal|floatformat:2 }} €</p>
                <p><strong>IVA (21%):</strong> {{ factura.iva|floatformat:2 }} €</p>
                <hr>
                <h3 style="margin-bottom: 5px;"><strong>TOTAL FACTURA:</strong> {{ factura.total_final|floatformat:2 }} €</h3>
            {% else %}
                <h3 style="margin-bottom: 5px;"><strong>TOTAL RECIBO:</strong> {{ factura.total_final|floatformat:2 }} €</h3>
            {% endif %}
            <p><strong>Pagado a cuenta (Abonos):</strong> -{{ abonos|floatformat:2 }} €</p>
            <h3 style="margin-top: 5px;"><strong style="color: #dc3545;">PENDIENTE DE PAGO:</strong> {{ pendiente|floatformat:2 }} €</h3>
        </div>
    </div>
</body>
</html>