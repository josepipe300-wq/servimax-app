<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Presupuesto - ServiMax</title>
    <link rel="stylesheet" href="{% static 'taller/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
</head>
<body>
    <div class="form-container">
        <div class="header">
            <h1>Nuevo Presupuesto</h1>
            <a href="{% url 'home' %}" class="back-btn">← Cancelar y Volver</a>
        </div>
        <hr>

        <form id="presupuesto-form" action="{% url 'crear_presupuesto' %}" method="post">
            {% csrf_token %}

            <div class="section">
                <h2>Cliente</h2>
                <label for="cliente_existente">Seleccionar Cliente Existente:</label>
                <select id="cliente_existente" name="cliente_existente">
                    <option value="">--- O Crear Nuevo Cliente Abajo ---</option>
                    {% for c_data in clientes_data %}
                        {% with cliente=c_data.cliente %}
                        <option value="{{ cliente.id }}" data-cliente-json="{{ c_data.cliente_data_json|escape }}">
                            {{ cliente.nombre }} ({{ cliente.telefono }})
                        </option>
                        {% endwith %}
                    {% endfor %}
                </select>

                <div id="nuevo_cliente_fields">
                    <label for="cliente_nombre">Nombre o Razón Social:</label>
                    <input type="text" id="cliente_nombre" name="cliente_nombre">
                    <label for="cliente_telefono">Teléfono:</label>
                    <input type="text" id="cliente_telefono" name="cliente_telefono">

                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Datos Fiscales (Para Facturas)</h3>
                
                    <div class="address-grid">
                        <div>
                            <label for="cliente_tipo_documento">Tipo Doc.:</label>
                            <select id="cliente_tipo_documento" name="cliente_tipo_documento">
                                <option value="DNI">DNI</option>
                                <option value="NIE">NIE</option>
                                <option value="NIF">NIF (Empresas)</option>
                            </select>
                        </div>
                        <div>
                            <label for="cliente_documento_fiscal">Nº Documento:</label>
                            <input type="text" id="cliente_documento_fiscal" name="cliente_documento_fiscal">
                        </div>
                    </div>

                    <label for="cliente_direccion_fiscal">Dirección Fiscal (Calle, nº):</label>
                    <input type="text" id="cliente_direccion_fiscal" name="cliente_direccion_fiscal">
                    
                    <div class="address-grid">
                        <div>
                            <label for="cliente_codigo_postal_fiscal">Código Postal:</label>
                            <input type="text" id="cliente_codigo_postal_fiscal" name="cliente_codigo_postal_fiscal">
                        </div>
                        <div>
                            <label for="cliente_ciudad_fiscal">Población:</label>
                            <input type="text" id="cliente_ciudad_fiscal" name="cliente_ciudad_fiscal">
                        </div>
                    </div>
                    <label for="cliente_provincia_fiscal">Provincia:</label>
                    <input type="text" id="cliente_provincia_fiscal" name="cliente_provincia_fiscal" value="TARRAGONA">
                </div>
            </div>

            <div class="section">
                <h2>Vehículo</h2>
                 <label for="vehiculo_existente">Seleccionar Vehículo Existente:</label>
                 <select id="vehiculo_existente" name="vehiculo_existente">
                    <option value="">--- O Introducir Datos Abajo ---</option>
                    {% for vehiculo in vehiculos %}
                        <option value="{{ vehiculo.id }}" data-cliente="{{ vehiculo.cliente.id }}">{{ vehiculo }}</option>
                    {% endfor %}
                </select>

                 <div id="nuevo_vehiculo_fields">
                    <label for="matricula_nueva">Matrícula Nueva:</label>
                    <input type="text" id="matricula_nueva" name="matricula_nueva">
                    <label for="marca_nueva">Marca Nueva:</label>
                    <input type="text" id="marca_nueva" name="marca_nueva">
                    <label for="modelo_nuevo">Modelo Nuevo:</label>
                    <input type="text" id="modelo_nuevo" name="modelo_nuevo">
                 </div>
            </div>

            <div class="section">
                <h2>Descripción del Trabajo</h2>
                <label for="problema_o_trabajo">Problema / Tareas a presupuestar:</label>
                <textarea id="problema_o_trabajo" name="problema_o_trabajo" required></textarea>
            </div>

            <div class="section">
                <h2>Líneas del Presupuesto</h2>
                <div id="lineas-container">
                    </div>
                <button type="button" class="btn-add" id="add-linea-btn">+ Añadir Línea</button>
            </div>

            <button type="submit" class="btn-submit-green">Guardar Presupuesto</button>
        </form>
    </div>

    <script>
        // --- SECCIÓN DE CLIENTE ---
        const clienteSelect = document.getElementById('cliente_existente');
        const nuevoClienteFields = document.getElementById('nuevo_cliente_fields');
        const nombreClienteInput = document.getElementById('cliente_nombre');
        const telefonoClienteInput = document.getElementById('cliente_telefono');
        const tipoDocumentoInput = document.getElementById('cliente_tipo_documento');
        const documentoFiscalInput = document.getElementById('cliente_documento_fiscal');
        const direccionFiscalInput = document.getElementById('cliente_direccion_fiscal');
        const codigoPostalFiscalInput = document.getElementById('cliente_codigo_postal_fiscal');
        const ciudadFiscalInput = document.getElementById('cliente_ciudad_fiscal');
        const provinciaFiscalInput = document.getElementById('cliente_provincia_fiscal');

        function toggleNuevoCliente() {
            const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            const clienteSeleccionado = clienteSelect.value;

            if (clienteSeleccionado) {
                nuevoClienteFields.classList.add('hidden');
                const clienteData = JSON.parse(selectedOption.getAttribute('data-cliente-json'));
                nombreClienteInput.value = selectedOption.text.split(' (')[0].trim();
                telefonoClienteInput.value = selectedOption.text.match(/\(([^)]+)\)/)[1];
                tipoDocumentoInput.value = clienteData.tipo_documento || 'DNI';
                documentoFiscalInput.value = clienteData.documento_fiscal || '';
                direccionFiscalInput.value = clienteData.direccion_fiscal || '';
                codigoPostalFiscalInput.value = clienteData.codigo_postal_fiscal || '';
                ciudadFiscalInput.value = clienteData.ciudad_fiscal || '';
                provinciaFiscalInput.value = clienteData.provincia_fiscal || 'TARRAGONA';
            } else {
                nuevoClienteFields.classList.remove('hidden');
                nombreClienteInput.value = '';
                telefonoClienteInput.value = '';
                tipoDocumentoInput.value = 'DNI';
                documentoFiscalInput.value = '';
                direccionFiscalInput.value = '';
                codigoPostalFiscalInput.value = '';
                ciudadFiscalInput.value = '';
                provinciaFiscalInput.value = 'TARRAGONA';
            }
            filterVehiculos();
        }

        // --- SECCIÓN DE VEHÍCULO ---
        const vehiculoSelect = document.getElementById('vehiculo_existente');
        const nuevoVehiculoFields = document.getElementById('nuevo_vehiculo_fields');

        function toggleNuevoVehiculo() {
            if (vehiculoSelect.value) {
                nuevoVehiculoFields.classList.add('hidden');
                document.getElementById('matricula_nueva').value = '';
                document.getElementById('marca_nueva').value = '';
                document.getElementById('modelo_nuevo').value = '';
            } else {
                nuevoVehiculoFields.classList.remove('hidden');
            }
        }

        function filterVehiculos() {
            const selectedClienteId = clienteSelect.value;
            vehiculoSelect.value = "";
            toggleNuevoVehiculo(); 

            for (const option of vehiculoSelect.options) {
                if (option.value === "") continue; 
                const vehiculoClienteId = option.getAttribute('data-cliente');
                if (selectedClienteId && vehiculoClienteId === selectedClienteId) {
                    option.style.display = 'block';
                } else if (selectedClienteId) {
                    option.style.display = 'none'; 
                } else {
                    option.style.display = 'block'; 
                }
            }
             if (vehiculoSelect.options[vehiculoSelect.selectedIndex]?.style.display === 'none') {
                vehiculoSelect.value = "";
                toggleNuevoVehiculo();
             }
        }

        // --- SECCIÓN DE LÍNEAS ---
        const lineasContainer = document.getElementById('lineas-container');
        const addLineaBtn = document.getElementById('add-linea-btn');

        function addLinea() {
            const newLinea = document.createElement('div');
            newLinea.classList.add('linea-item');
            newLinea.innerHTML = `
                <select name="linea_tipo" required>
                    <option value="">Tipo...</option>
                    {% for value, name in tipos_linea %}
                    <option value="{{ value }}">{{ name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="linea_descripcion" placeholder="Descripción" required>
                <input type="number" step="0.01" name="linea_cantidad" placeholder="Cant." value="1" required>
                <input type="number" step="0.01" name="linea_precio_unitario" placeholder="Precio Unit. (€)" required>
                <button type="button" class="btn-remove" onclick="removeLinea(this)">X</button>
            `;
            lineasContainer.appendChild(newLinea);
        }

        function removeLinea(button) {
            button.closest('.linea-item').remove();
        }

        // --- Event listeners ---
        clienteSelect.addEventListener('change', toggleNuevoCliente);
        vehiculoSelect.addEventListener('change', toggleNuevoVehiculo);
        addLineaBtn.addEventListener('click', addLinea);

        // --- Estado inicial ---
        toggleNuevoCliente();
        addLinea(); 
    </script>
</body>
</html>