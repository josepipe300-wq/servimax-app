<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Editar {% if factura_existente.es_factura %}Factura Nº {{ factura_existente.numero_factura }}{% else %}Recibo Nº {{ factura_existente.id }}{% endif %} - ServiMax</title>
    
    <link rel="stylesheet" href="{% static 'taller/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'taller/css/responsive.css' %}">
    <style>
        /* Estilos específicos para alinear mejor los items en esta pantalla */
        .item-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .item-row input, .item-row select {
            margin-bottom: 0 !important; /* Quitar margen inferior por defecto */
        }
        .btn-remove-line {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 38px; /* Misma altura que los inputs */
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
        }
        .btn-remove-line:hover {
            background-color: #c82333;
        }
        @media (max-width: 600px) {
            .item-row {
                flex-wrap: wrap;
            }
            .item-row input[name$="desc"] {
                width: 100%;
                order: 1;
            }
            .item-row input[type="number"] {
                flex-grow: 1;
                order: 2;
            }
            .btn-remove-line {
                order: 3;
            }
        }
    </style>
</head>
<body>
    <div class="form-container"> 
        <div class="header">
            <h1>Editando {% if factura_existente.es_factura %}Factura Nº {{ factura_existente.numero_factura }}{% else %}Recibo Nº {{ factura_existente.id }}{% endif %}</h1>
            <a href="{% url 'detalle_orden' orden.id %}" class="back-btn">← Cancelar y Volver</a>
        </div>
        <hr>

        <form id="factura-form" action="{% url 'editar_factura' factura_existente.id %}" method="post">
            {% csrf_token %}
            
            {% if repuestos %}
            <h4>Repuestos</h4>
            {% for repuesto in repuestos %}
                <label>{{ repuesto.descripcion }} (Coste: {{ repuesto.importe|floatformat:2 }}€)</label>
                <input type="number" step="0.01" name="pvp_repuesto_{{ repuesto.id }}" class="pvp-input" data-coste="{{ repuesto.importe }}" placeholder="PVP Repuesto">
            {% endfor %}
            {% endif %}

            {% if gastos_otros %}
            <h4>Trabajos Externos</h4>
            {% for gasto in gastos_otros %}
                <label>{{ gasto.descripcion }} (Coste: {{ gasto.importe|floatformat:2 }}€)</label>
                <input type="number" step="0.01" name="pvp_otro_{{ gasto.id }}" class="pvp-input" data-coste="{{ gasto.importe }}" placeholder="PVP Trabajo Externo">
            {% endfor %}
            {% endif %}

            <h4>Consumibles</h4>
            <div id="consumibles-container">
            </div>
            <button type="button" id="add-consumible-btn" class="btn-add" style="margin-bottom: 20px;">+ Añadir Consumible</button>
            
            <h4 style="margin-top: 20px;">Mano de Obra</h4>
            <div id="mano-de-obra-container">
            </div>
            <button type="button" id="add-mano-obra" class="btn-add">+ Añadir línea de trabajo</button>
            
            <h4 style="margin-top: 20px;">Finalizar</h4>
            <div class="checkbox-container">
                <input type="checkbox" id="aplicar_iva" name="aplicar_iva" {% if factura_existente.es_factura %}checked{% endif %}>
                <label for="aplicar_iva" style="margin-bottom: 0; font-weight: normal;">Generar FACTURA (Aplicar IVA 21%)</label>
            </div>
            <hr>
            <button type="submit" class="btn-submit-yellow">Guardar Cambios</button>
        </form>
    </div>
    
    <script>
        const lineasExistentes = JSON.parse('{{ lineas_existentes_json|escapejs }}');

        function addManoDeObra(lineaData = null) {
            const container = document.getElementById('mano-de-obra-container');
            const newItem = document.createElement('div');
            newItem.classList.add('item-row'); // Usamos clase flex
            
            newItem.innerHTML = `
                <input type="text" name="mano_obra_desc" placeholder="Descripción del trabajo" value="${lineaData ? lineaData.descripcion : ''}" required style="flex-grow: 2;">
                <input type="number" step="0.01" name="mano_obra_importe" placeholder="Importe (€)" value="${lineaData ? lineaData.precio_unitario : ''}" required style="flex-grow: 1;">
                <button type="button" class="btn-remove-line" onclick="this.parentElement.remove()" title="Eliminar línea">X</button>
            `;
            container.appendChild(newItem);
        }

        function addConsumible(lineaData = null) {
            const container = document.getElementById('consumibles-container');
            const newItem = document.createElement('div');
            newItem.classList.add('consumible-item');
            
            let pvpTotal = '';
            if (lineaData) {
                const cantidad = parseFloat(lineaData.cantidad);
                const precioUnitario = parseFloat(lineaData.precio_unitario);
                if (!isNaN(cantidad) && !isNaN(precioUnitario)) {
                     pvpTotal = (cantidad * precioUnitario).toFixed(2);
                }
            }
            
            let optionsHTML = '<option value="">--- Selecciona tipo ---</option>';
            {% for tipo in tipos_consumible %}
                optionsHTML += `<option value="{{ tipo.id }}" ${ (lineaData && lineaData.tipo_consumible_id === {{ tipo.id }}) ? 'selected' : '' }>{{ tipo.nombre }}</option>`;
            {% endfor %}
            
            // Estructura: Fila 1 (Select + Botón Borrar), Fila 2 (Inputs)
            newItem.innerHTML = `
                <div class="item-row">
                    <select name="tipo_consumible" required style="flex-grow: 1;">${optionsHTML}</select>
                    <button type="button" class="btn-remove-line" onclick="this.closest('.consumible-item').remove()" title="Eliminar consumible">X</button>
                </div>
                <div class="item-row">
                    <input type="number" step="0.01" name="consumible_cantidad" placeholder="Cant. Usada" value="${lineaData ? lineaData.cantidad : ''}" required style="flex-grow: 1;">
                    <input type="number" step="0.01" name="consumible_pvp_total" placeholder="Total a Cobrar (€)" value="${pvpTotal}" required style="flex-grow: 1;">
                </div>
                <hr style="margin-top: 5px; margin-bottom: 15px; border-top: 1px dashed #ccc;">
            `;
            container.appendChild(newItem);
        }

        document.getElementById('add-mano-obra').addEventListener('click', () => addManoDeObra());
        document.getElementById('add-consumible-btn').addEventListener('click', () => addConsumible());

        document.addEventListener('DOMContentLoaded', () => {
            let hasManoDeObra = false;
            
            if (lineasExistentes && lineasExistentes.length > 0) {
                lineasExistentes.forEach(linea => {
                    if (linea.tipo === 'Repuesto' && linea.repuesto_id) {
                        const input = document.querySelector(`input[name="pvp_repuesto_${linea.repuesto_id}"]`);
                        if (input) {
                            input.value = linea.precio_unitario;
                        }
                    } else if (linea.tipo === 'Externo' && linea.externo_id) {
                        const input = document.querySelector(`input[name="pvp_otro_${linea.externo_id}"]`);
                        if (input) {
                            input.value = linea.precio_unitario;
                        }
                    } else if (linea.tipo === 'Consumible') {
                        addConsumible(linea);
                    } else if (linea.tipo === 'Mano de Obra') {
                        addManoDeObra(linea);
                        hasManoDeObra = true;
                    }
                });
            }

            // Si no hay mano de obra registrada, añadir una línea vacía por defecto para facilitar
            if (!hasManoDeObra) {
                addManoDeObra();
            }

            const facturaForm = document.getElementById('factura-form');
            if (facturaForm) {
                facturaForm.addEventListener('submit', function(event) {
                    let preciosInvalidos = false;
                    const pvpInputs = this.querySelectorAll('.pvp-input');
                    
                    pvpInputs.forEach(input => {
                        const pvp = parseFloat(input.value);
                        const coste = parseFloat(input.dataset.coste);
                        // Solo validar si el usuario ha escrito un precio
                        if (!isNaN(pvp) && pvp < coste) {
                            preciosInvalidos = true;
                            const labelText = input.previousElementSibling.textContent.split('(')[0].trim();
                            alert(`El PVP de "${labelText}" no puede ser menor que su coste de ${coste.toFixed(2)}€.`);
                        }
                    });

                    if (preciosInvalidos) {
                        event.preventDefault();
                    }
                });

                // Evitar enviar formulario al pulsar Enter en inputs
                facturaForm.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                        event.preventDefault();
                        const formElements = Array.from(this.elements).filter(el => el.offsetParent !== null && !el.disabled);
                        const currentIndex = formElements.indexOf(event.target);
                        const nextElement = formElements[currentIndex + 1];
                        if (nextElement) {
                            nextElement.focus();
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>